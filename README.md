# CredentialManager

## Overview
Fabric uses CILogon 2.0 and COmanage for Identity Authentication and Authorization management. 
Fabric Credential Manager provides generate and refreshes credentials for Fabric users. 
This package includes:
 - A Flask application that users can be directed to in order to obtain OAuth2 tokens from CILogon.
 - Swagger generated Server which supports APIs to create/get/delete/refresh tokens
 - CredMgr daemon which monitors and refreshes the saved tokens 

## Requirements
- Python 3.6+
- HTTPS-enabled web server 
- WSGI server
```
yum install httpd
yum install mod_wsgi
yum install mod_ssl
yum install httpd-devel
yum install python3
yum install python3-devel
pip3 install mod-wsgi
mod_wsgi-express install-module > /etc/httpd/conf.modules.d/02-wsgi.conf
```

## API
API Documentation can be found [here](https://app.swaggerhub.com/apis-docs/kthare10/credmgr/1.0.0#/)

## Swagger Server
The swagger server was generated by the [swagger-codegen](https://github.com/swagger-api/swagger-codegen) project. By using the
[OpenAPI-Spec](https://github.com/swagger-api/swagger-core/wiki) from a remote server, you can easily generate a server stub.  This
is an example of building a swagger-enabled Flask server.

This example uses the [Connexion](https://github.com/zalando/connexion) library on top of Flask.

## Generate a new server stub
In a browser, go to [Swagger definition](https://app.swaggerhub.com/apis/kthare10/credmgr/1.0.0)

From the generate code icon (downward facing arrow), select Download API > JSON Resolved

A file named swagger-client-generated.zip should be downloaded. This file will contain swagger.json. Extract the json file from the swagger-client-generated.zip and run the following command to generate the Flask based server.

```bash
$ swagger-codegen generate -i swagger.json -l python-flask -o credmgr
```

## Usage
To run the Credential Manage, please execute the following from the root directory:

 ```
 git clone https://github.com/fabric-testbed/CredentialManager.git 
 ./install.sh
 ```
## Running with Docker

 To run the server on a Docker container, please execute the following from the root directory:

 ```bash
 # building the image
 docker build -t credmgr .

 # starting up a container
 docker run -p 8082:8082 credmgr

 # bring using via docker-compose
 docker-compose up -d
 ```
## Example

Create a tokens for all projects and all scope
```bash
curl -X POST -i "localhost:8082/fabric/credmgr/create" -H "accept: application/json"
HTTP/1.0 200 OK
Content-Type: application/json
Content-Length: 187
Server: Werkzeug/1.0.0 Python/3.6.8
Date: Sat, 14 Mar 2020 14:10:37 GMT

{
  "message": "Please visit https://credmgr:443/key/54343CC3EDE64847822718F5800EBA46! Use 54343CC3EDE64847822718F5800EBA46 to retrieve the token after authentication",
  "status": 200
}
```

Get token for userId '54343CC3EDE64847822718F5800EBA46'
```bash
curl -X GET -i "localhost:8082/fabric/credmgr/get?userId=54343CC3EDE64847822718F5800EBA46" -H "accept: application/json"
HTTP/1.0 200 OK
Content-Type: application/json
Content-Length: 1624
Server: Werkzeug/1.0.0 Python/3.6.8
Date: Sat, 14 Mar 2020 14:11:24 GMT

{
  "status": 200,
  "value": {
    "id_token": "eyJ0eXAiOiJKV1QiLCJraWQiOiIyNDRCMjM1RjZCMjhFMzQxMDhEMTAxRUFDNzM2MkM0RSIsImFsZyI6IlJTMjU2In0.eyJpc3MiOiJodHRwczovL2NpbG9nb24ub3JnIiwic3ViIjoiaHR0cDovL2NpbG9nb24ub3JnL3NlcnZlckEvdXNlcnMvMTE5MDQxMDEiLCJhdWQiOiJjaWxvZ29uOi9jbGllbnRfaWQvNzdlMWFlYTAyMGE0Njc2OTM3ZWFhMjJkZjFkNDMyZDgiLCJhdXRoX3RpbWUiOiIxNTg0MTk1MDUyIiwiZXhwIjoxNTg0MTk1OTUzLCJpYXQiOjE1ODQxOTUwNTMsImVtYWlsIjoia3RoYXJlMTBAZW1haWwudW5jLmVkdSIsImdpdmVuX25hbWUiOiJLb21hbCIsImZhbWlseV9uYW1lIjoiVGhhcmVqYSIsImNlcnRfc3ViamVjdF9kbiI6Ii9EQz1vcmcvREM9Y2lsb2dvbi9DPVVTL089VW5pdmVyc2l0eSBvZiBOb3J0aCBDYXJvbGluYSBhdCBDaGFwZWwgSGlsbC9DTj1Lb21hbCBUaGFyZWphIEExMTkwNDEwNiIsImlkcCI6InVybjptYWNlOmluY29tbW9uOnVuYy5lZHUiLCJpZHBfbmFtZSI6IlVuaXZlcnNpdHkgb2YgTm9ydGggQ2Fyb2xpbmEgYXQgQ2hhcGVsIEhpbGwiLCJlcHBuIjoia3RoYXJlMTBAdW5jLmVkdSIsImFmZmlsaWF0aW9uIjoiZW1wbG95ZWVAdW5jLmVkdTtzdGFmZkB1bmMuZWR1O21lbWJlckB1bmMuZWR1IiwibmFtZSI6IktvbWFsIFRoYXJlamEiLCJhY3IiOiJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YWM6Y2xhc3NlczpQYXNzd29yZFByb3RlY3RlZFRyYW5zcG9ydCIsImVudGl0bGVtZW50IjoidXJuOm1hY2U6ZGlyOmVudGl0bGVtZW50OmNvbW1vbi1saWItdGVybXMifQ.GNHSbN6Ftq8rAfY-GEr0oJe8VXd9sBwyih0Q05sD6Mg-0PdTwyqSODJNv--vSS5o9i6Zi_JGKvjCxCg4ce30JuB_OCmY0zDwLaedBzILlfVmwbuwAQMnzg9yxBGqSW8O2tdoMVqausjQj6BZ5EuUA9pvT-IwK6lDJPVvTZ42FURsJfZXCyRSqafxXrJFQg7-fHxY6KmG2RY_J8ChOKN07o519G0Tr8N4pmqmGa5j0FIACyL4tznFY8yJ6ccBLxxEMGDqIMHO_Xc-P0b6powF4_6CktLX3Qqf_2w8hquvDqa_e6OHd8uNbuA3kcGuMhFdu2M8r0byzEIJjhSSYXM_vw",
    "refresh_token": "https://cilogon.org/oauth2/refreshToken/74a8d3b23765f0fd5f19ce0c646c60b4/1584195053226",
    "user_id": "54343CC3EDE64847822718F5800EBA46"
  }
}
```

Refresh token for user '54343CC3EDE64847822718F5800EBA46'
```bash
curl -X POST -i "localhost:8082/fabric/credmgr/refresh?userId=54343CC3EDE64847822718F5800EBA46" -H "accept: application/json" -H "Content-Type: application/json" -d '{"refresh_token":"https://cilogon.org/oauth2/refreshToken/74a8d3b23765f0fd5f19ce0c646c60b4/1584195053226"}'
HTTP/1.0 200 OK
Content-Type: application/json
Content-Length: 1624
Server: Werkzeug/1.0.0 Python/3.6.8
Date: Sat, 14 Mar 2020 14:13:30 GMT

{
  "status": 200,
  "value": {
    "id_token": "eyJ0eXAiOiJKV1QiLCJraWQiOiIyNDRCMjM1RjZCMjhFMzQxMDhEMTAxRUFDNzM2MkM0RSIsImFsZyI6IlJTMjU2In0.eyJpc3MiOiJodHRwczovL2NpbG9nb24ub3JnIiwic3ViIjoiaHR0cDovL2NpbG9nb24ub3JnL3NlcnZlckEvdXNlcnMvMTE5MDQxMDEiLCJhdWQiOiJjaWxvZ29uOi9jbGllbnRfaWQvNzdlMWFlYTAyMGE0Njc2OTM3ZWFhMjJkZjFkNDMyZDgiLCJhdXRoX3RpbWUiOiIxNTg0MTk1MDUyIiwiZXhwIjoxNTg0MTk2MTEwLCJpYXQiOjE1ODQxOTUyMTAsImVtYWlsIjoia3RoYXJlMTBAZW1haWwudW5jLmVkdSIsImdpdmVuX25hbWUiOiJLb21hbCIsImZhbWlseV9uYW1lIjoiVGhhcmVqYSIsImNlcnRfc3ViamVjdF9kbiI6Ii9EQz1vcmcvREM9Y2lsb2dvbi9DPVVTL089VW5pdmVyc2l0eSBvZiBOb3J0aCBDYXJvbGluYSBhdCBDaGFwZWwgSGlsbC9DTj1Lb21hbCBUaGFyZWphIEExMTkwNDEwNiIsImlkcCI6InVybjptYWNlOmluY29tbW9uOnVuYy5lZHUiLCJpZHBfbmFtZSI6IlVuaXZlcnNpdHkgb2YgTm9ydGggQ2Fyb2xpbmEgYXQgQ2hhcGVsIEhpbGwiLCJlcHBuIjoia3RoYXJlMTBAdW5jLmVkdSIsImFmZmlsaWF0aW9uIjoiZW1wbG95ZWVAdW5jLmVkdTtzdGFmZkB1bmMuZWR1O21lbWJlckB1bmMuZWR1IiwibmFtZSI6IktvbWFsIFRoYXJlamEiLCJhY3IiOiJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YWM6Y2xhc3NlczpQYXNzd29yZFByb3RlY3RlZFRyYW5zcG9ydCIsImVudGl0bGVtZW50IjoidXJuOm1hY2U6ZGlyOmVudGl0bGVtZW50OmNvbW1vbi1saWItdGVybXMifQ.B18BxMBBNR3U6NenjxYojk-42CUsbWPoQCgZ7CnWfx_xwqEMEiwXxB8zDA0Vs7rRdU3X6Tu0SwVqs4WL3kVpzft5TJDbqiWf0ySrEVXRKUdwJX5GJhkmDtXhRg06AshuRv0sAVykHRnuRU_E67kXRWSWXcckVEU_nSyyTwxdVfkpi55OeV2XD2u_ZXEYCl1Mo9lmpJtd9yn3_tNfQKKK9EwJ-Npg9GNvGrKQ7aNcs38Qy4vyN_EnXJJ0mckVTC5YcKACO-xW80X34mHuTQeRsyNZTqJkLp2x4nL363tj1UX5KBmJcBbWyWQawZuz1-IpR36CqRyZ4UtbxxpMk78vpg",
    "refresh_token": "https://cilogon.org/oauth2/refreshToken/5658311bb211c072ae50a2d2e0f58350/1584195209846",
    "user_id": "54343CC3EDE64847822718F5800EBA46"
  }
}
```

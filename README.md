# CredentialManager

## Overview
Fabric uses CILogon 2.0 and COmanage for Identity Authentication and Authorization management. 
Fabric Credential Manager provides generate and refreshes credentials for Fabric users. 
This package includes:
 - A Flask application that users would be directed for authentication via CILogon.
 - Swagger generated REST Server which supports APIs to create/get/refresh/revoke tokens
 - CredMgr daemon which deletes stale key files and expired tokens
 
 ![Component Diagram](./images/credmgr.png)

## Requirements
- Python 3.6+
- HTTPS-enabled web server 
- WSGI server
```
yum install httpd
yum install mod_wsgi
yum install mod_ssl
yum install httpd-devel
yum install python3
yum install python3-devel
pip3 install mod-wsgi
mod_wsgi-express install-module > /etc/httpd/conf.modules.d/02-wsgi.conf
```

## API
API Documentation can be found [here](https://app.swaggerhub.com/apis-docs/kthare10/credmgr/1.0.0#/)

## Swagger Server
The swagger server was generated by the [swagger-codegen](https://github.com/swagger-api/swagger-codegen) project. By using the
[OpenAPI-Spec](https://github.com/swagger-api/swagger-core/wiki) from a remote server, you can easily generate a server stub.  This
is an example of building a swagger-enabled Flask server.

This example uses the [Connexion](https://github.com/zalando/connexion) library on top of Flask.

## Generate a new server stub
In a browser, go to [Swagger definition](https://app.swaggerhub.com/apis/kthare10/credmgr/1.0.0)

From the generate code icon (downward facing arrow), select Download API > JSON Resolved

A file named swagger-client-generated.zip should be downloaded. This file will contain swagger.json. Extract the json file from the swagger-client-generated.zip and run the following command to generate the Flask based server.

```bash
$ swagger-codegen generate -i swagger.json -l python-flask -o credmgr
```

## Usage
To run the Credential Manager, please execute the following from the root directory:

 ```
 git clone https://github.com/fabric-testbed/CredentialManager.git 
 ./install.sh
 ```
## Running with Docker
User is expected to update following in docker/config file:
```
oauth-client-id = 
oauth-client-secret = 
oauth-return-url = 

ldap-host = 
ldap-user = 
ldap-password = 
ldap-search-base =

db-user = 
db-password = 
db-name = 
```

Update the docker-compose.yml for database user, password, and database name. Also, point credmgr certificates to Trusted Certificates. Update port mapping as needed.
```
    database:
        image: postgres:10
        container_name: cred_database
        restart: always
        environment:
        - POSTGRES_PASSWORD=credmgr
        - POSTGRES_USER=credmgr
        - POSTGRES_DB=credmgr
        ports:
        - 5432:${POSTGRES_PORT:-5432}
    credmgr:
        container_name: credmgr
        hostname: credmgr
        image: credmgr:latest
        restart: always
        privileged: true
        cap_add:
            - SYS_ADMIN
        security_opt:
            - seccomp:unconfined
        tmpfs:
            - /run
            - /run/lock
        volumes:
            - /sys/fs/cgroup:/sys/fs/cgroup:ro
            - ./log:/var/log
            - "./docker/config:/etc/credmgr/config_docker"
            - "./docker/self.signed.crt:/etc/credmgr/hostcert.pem"
            - "./docker/self.signed.key:/etc/credmgr/hostkey.pem"        
        ports:
        - "8082:8080"
        - "443:443"        
        - "8100:8100"
```
To run the server on a Docker container, please execute the following from the root directory:

 ```bash
 # building the image
 docker build -t credmgr .

 # bring using via docker-compose
 docker-compose up -d
 ```

## Logging
Credential Manager logs can be sent to ELK using filebeat and logstash either directly or via Kafka.

### Filebeat Configuration
Filebeat inputs should be configured as follows for Credential Manager. Path should be updated as per the location on the system running Credential Manager.
```
filebeat.inputs:

# Each - is an input. Most options can be set at the input level, so
# you can use different inputs for various configurations.
# Below are the input specific configurations.

- type: log

  # Change to true to enable this input configuration.
  enabled: true

  # Paths that should be crawled and fetched. Glob based paths.
  paths:
    - /opt/CredentialManager/log/credmgr/*.log
    - /opt/CredentialManager/log/httpd/credmgr*.log
```

# Logstash Filters
Credential Manager requires following filters to be configured in logstash.
```
filter {
  grok {
        pattern_definitions => { "GREEDYMULTILINE" => "(.|\n)*"
                                 "SYSTIME" => "%{SYSLOGTIMESTAMP}%{SPACE}%{YEAR}" }
        match => {
          "message" => [
                          "%{TIMESTAMP_ISO8601:fabric_log_timestamp}%{SPACE}-%{SPACE}%{NOTSPACE:fabric_component}%{SPACE}-%{SPACE}%{NOTSPACE:fabric_location}%{SPACE}-%{SPACE}%{NOTSPACE:fabric_log_level}%{SPACE}-%{SPACE}%{GREEDYMULTILINE:fabric_log_message}",
                          "%{TIMESTAMP_ISO8601:fabric_log_timestamp}%{SPACE}-%{SPACE}%{NOTSPACE:fabric_component}%{SPACE}-%{SPACE}%{NOTSPACE:fabric_log_level}%{SPACE}-%{SPACE}%{GREEDYMULTILINE:fabric_log_message}",
                          "%{DAY}%{SPACE}%{SYSTIME:syslog_timestamp}]?%{SPACE}\[?%{PROG:syslog_program}\]?%{SPACE}\[?%{WORD}%{SPACE}%{WORD:syslog_pid}\]?%{GREEDYDATA:syslog_message}",
                          "%{COMMONAPACHELOG}"
                       ]
        }
      }
  }
```

## Metrics
Credential Manager is integrated to following metrics collected by Prometheus. User can view the metrics by 'http://localhost:8100/' once the container is running.
- Requests_Received : HTTP Requests received
- Requests_Success : HTTP Requests processed successfully
- Requests_Failed : HTTP Requests failed

### Sample output
```
# HELP Requests_Received_total HTTP Requests
# TYPE Requests_Received_total counter
Requests_Received_total{endpoint="/fabric/credmgr/create",method="post"} 1.0
Requests_Received_total{endpoint="/fabric/credmgr/get",method="get"} 1.0
Requests_Received_total{endpoint="/fabric/credmgr/refresh",method="post"} 1.0
Requests_Received_total{endpoint="/fabric/credmgr/revoke",method="post"} 1.0
# TYPE Requests_Received_created gauge
Requests_Received_created{endpoint="/fabric/credmgr/create",method="post"} 1.5893885201837184e+09
Requests_Received_created{endpoint="/fabric/credmgr/get",method="get"} 1.5893885393205898e+09
Requests_Received_created{endpoint="/fabric/credmgr/refresh",method="post"} 1.589388545705302e+09
Requests_Received_created{endpoint="/fabric/credmgr/revoke",method="post"} 1.589388551077782e+09
# HELP Requests_Success_total HTTP Success
# TYPE Requests_Success_total counter
Requests_Success_total{endpoint="/fabric/credmgr/create",method="post"} 1.0
# TYPE Requests_Success_created gauge
Requests_Success_created{endpoint="/fabric/credmgr/create",method="post"} 1.589388520186303e+09
# HELP Requests_Failed_total HTTP Failures
# TYPE Requests_Failed_total counter
Requests_Failed_total{endpoint="/fabric/credmgr/get",method="get"} 1.0
Requests_Failed_total{endpoint="/fabric/credmgr/refresh",method="post"} 1.0
Requests_Failed_total{endpoint="/fabric/credmgr/revoke",method="post"} 1.0
# TYPE Requests_Failed_created gauge
Requests_Failed_created{endpoint="/fabric/credmgr/get",method="get"} 1.5893885393271635e+09
Requests_Failed_created{endpoint="/fabric/credmgr/refresh",method="post"} 1.5893885458823338e+09
Requests_Failed_created{endpoint="/fabric/credmgr/revoke",method="post"} 1.58938855169857e+09
```

## API Examples

### Create a tokens with projectName=all and scope=all
NOTE: In this case, it is not required to pass projectName and scope in query parameters as they default to all.
```bash
curl -X POST -i "localhost:8082/fabric/credmgr/create?projectName=all&scope=all" -H "accept: application/json"
HTTP/1.0 200 OK
Content-Type: application/json
Content-Length: 340
Server: Werkzeug/1.0.0 Python/3.6.8
Date: Thu, 19 Mar 2020 02:01:25 GMT

{
  "message": "Please visit https://credmgr:443/key/7016315FF8EF4D7F9E0A7550730A256D! Use 7016315FF8EF4D7F9E0A7550730A256D to retrieve the token after authentication",
  "status": 200,
  "value": {
    "authorization_url": "https://credmgr:443/key/7016315FF8EF4D7F9E0A7550730A256D",
    "user_id": "7016315FF8EF4D7F9E0A7550730A256D"
  }
}
```
### Create Token for projectName=RENCI-TEST and scope=measurement
```
curl -X POST -i "localhost:8082/fabric/credmgr/create?projectName=RENCI-TEST&scope=measurement" -H "accept: application/json"
HTTP/1.0 200 OK
Content-Type: application/json
Content-Length: 340
Server: Werkzeug/1.0.0 Python/3.6.8
Date: Thu, 19 Mar 2020 02:06:43 GMT

{
  "message": "Please visit https://credmgr:443/key/1548FCD4006D413AB4B11D04E1E9FC1C! Use 1548FCD4006D413AB4B11D04E1E9FC1C to retrieve the token after authentication",
  "status": 200,
  "value": {
    "authorization_url": "https://credmgr:443/key/1548FCD4006D413AB4B11D04E1E9FC1C",
    "user_id": "1548FCD4006D413AB4B11D04E1E9FC1C"
  }
}
```

### Get token for userId '7016315FF8EF4D7F9E0A7550730A256D'
```bash
curl -X GET -i "localhost:8082/fabric/credmgr/get?userId=7016315FF8EF4D7F9E0A7550730A256D" -H "accept: application/json"
HTTP/1.0 200 OK
Content-Type: application/json
Content-Length: 1624
Server: Werkzeug/1.0.0 Python/3.6.8
Date: Mon, 16 Mar 2020 18:30:23 GMT

{
  "status": 200,
  "value": {
    "id_token": "eyJ0eXAiOiJKV1QiLCJraWQiOiIyNDRCMjM1RjZCMjhFMzQxMDhEMTAxRUFDNzM2MkM0RSIsImFsZyI6IlJTMjU2In0.eyJpc3MiOiJodHRwczovL2NpbG9nb24ub3JnIiwic3ViIjoiaHR0cDovL2NpbG9nb24ub3JnL3NlcnZlckEvdXNlcnMvMTE5MDQxMDEiLCJhdWQiOiJjaWxvZ29uOi9jbGllbnRfaWQvNzdlMWFlYTAyMGE0Njc2OTM3ZWFhMjJkZjFkNDMyZDgiLCJhdXRoX3RpbWUiOiIxNTg0MzgzMzg3IiwiZXhwIjoxNTg0Mzg0Mjg3LCJpYXQiOjE1ODQzODMzODcsImVtYWlsIjoia3RoYXJlMTBAZW1haWwudW5jLmVkdSIsImdpdmVuX25hbWUiOiJLb21hbCIsImZhbWlseV9uYW1lIjoiVGhhcmVqYSIsImNlcnRfc3ViamVjdF9kbiI6Ii9EQz1vcmcvREM9Y2lsb2dvbi9DPVVTL089VW5pdmVyc2l0eSBvZiBOb3J0aCBDYXJvbGluYSBhdCBDaGFwZWwgSGlsbC9DTj1Lb21hbCBUaGFyZWphIEExMTkwNDEwNiIsImlkcCI6InVybjptYWNlOmluY29tbW9uOnVuYy5lZHUiLCJpZHBfbmFtZSI6IlVuaXZlcnNpdHkgb2YgTm9ydGggQ2Fyb2xpbmEgYXQgQ2hhcGVsIEhpbGwiLCJlcHBuIjoia3RoYXJlMTBAdW5jLmVkdSIsImFmZmlsaWF0aW9uIjoiZW1wbG95ZWVAdW5jLmVkdTtzdGFmZkB1bmMuZWR1O21lbWJlckB1bmMuZWR1IiwibmFtZSI6IktvbWFsIFRoYXJlamEiLCJhY3IiOiJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YWM6Y2xhc3NlczpQYXNzd29yZFByb3RlY3RlZFRyYW5zcG9ydCIsImVudGl0bGVtZW50IjoidXJuOm1hY2U6ZGlyOmVudGl0bGVtZW50OmNvbW1vbi1saWItdGVybXMifQ.d18gtV85V0ik4jfKyalguSgnmlszz--cNrQ4fWY2c29POQf1LgaMKpDlLrR_eQ1sz1TOMMtrqhgJ764CsJIVTqVtWEqL7vQsPFffRcO5rT80OdeOyKH5jQirbWEgGomEOzZg1GCtW9KFh88aVQtV6nnxhGD0Lua7tUJMzAfMm7_2exTw3EehqOt0thPVzKsOPlGCQ_iuc3FRDI2vMNbzpTsSXfgqpTAwwD9DXcSf9QfmuvwFaKIjOQAywR-HJBZ1TwFAZVIAeGzyR-2XuofX8TaAWZDfDyppe8q8-bf-_3-XhjBHtMJ8Z87SaiIfHyDdk4sG7SJoxx7Ry3DS5VPO6Q",
    "refresh_token": "https://cilogon.org/oauth2/refreshToken/46438248f4b7691a851f88b0849d9687/1584383387474",
    "user_id": "7016315FF8EF4D7F9E0A7550730A256D"
  }
}
```
### Refresh token with projectName=all and scope=all
```bash
curl -X POST -i "localhost:8082/fabric/credmgr/refresh?projectName=all&scope=all" -H "accept: application/json" -H "Content-Type: application/json" -d '{"refresh_token": "https://cilogon.org/oauth2/refreshToken/46438248f4b7691a851f88b0849d9687/1584383387474"}'
HTTP/1.0 200 OK
Content-Type: application/json
Content-Length: 1624
Server: Werkzeug/1.0.0 Python/3.6.8
Date: Mon, 16 Mar 2020 18:32:06 GMT

{
  "status": 200,
  "value": {
    "id_token": "eyJ0eXAiOiJKV1QiLCJraWQiOiIyNDRCMjM1RjZCMjhFMzQxMDhEMTAxRUFDNzM2MkM0RSIsImFsZyI6IlJTMjU2In0.eyJpc3MiOiJodHRwczovL2NpbG9nb24ub3JnIiwic3ViIjoiaHR0cDovL2NpbG9nb24ub3JnL3NlcnZlckEvdXNlcnMvMTE5MDQxMDEiLCJhdWQiOiJjaWxvZ29uOi9jbGllbnRfaWQvNzdlMWFlYTAyMGE0Njc2OTM3ZWFhMjJkZjFkNDMyZDgiLCJhdXRoX3RpbWUiOiIxNTg0MzgzMzg3IiwiZXhwIjoxNTg0Mzg0NDI2LCJpYXQiOjE1ODQzODM1MjYsImVtYWlsIjoia3RoYXJlMTBAZW1haWwudW5jLmVkdSIsImdpdmVuX25hbWUiOiJLb21hbCIsImZhbWlseV9uYW1lIjoiVGhhcmVqYSIsImNlcnRfc3ViamVjdF9kbiI6Ii9EQz1vcmcvREM9Y2lsb2dvbi9DPVVTL089VW5pdmVyc2l0eSBvZiBOb3J0aCBDYXJvbGluYSBhdCBDaGFwZWwgSGlsbC9DTj1Lb21hbCBUaGFyZWphIEExMTkwNDEwNiIsImlkcCI6InVybjptYWNlOmluY29tbW9uOnVuYy5lZHUiLCJpZHBfbmFtZSI6IlVuaXZlcnNpdHkgb2YgTm9ydGggQ2Fyb2xpbmEgYXQgQ2hhcGVsIEhpbGwiLCJlcHBuIjoia3RoYXJlMTBAdW5jLmVkdSIsImFmZmlsaWF0aW9uIjoiZW1wbG95ZWVAdW5jLmVkdTtzdGFmZkB1bmMuZWR1O21lbWJlckB1bmMuZWR1IiwibmFtZSI6IktvbWFsIFRoYXJlamEiLCJhY3IiOiJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoyLjA6YWM6Y2xhc3NlczpQYXNzd29yZFByb3RlY3RlZFRyYW5zcG9ydCIsImVudGl0bGVtZW50IjoidXJuOm1hY2U6ZGlyOmVudGl0bGVtZW50OmNvbW1vbi1saWItdGVybXMifQ.c5yAC1TanrIBF3h4NISk8hRSzSPu0uvetzv8JoZ65o3BE3TH6U85ZszLA1PUjTB6X55OzkxyqabgUw6kcPRGfLwbdWqVmYDmGDB1E2Y9Qxnhv_4Colan8po0bwA86Oc2Npbjmxr5njXuR_FdIq5NfGVOP8sov5z7kYSHHp4Pur9CtyyLc9eHIIqAfMOoNwRzRqGxT9dZ-LioHpVnyFDM_Zcxf3nZe3iz2WV7NFzVhL7xTLe8VxEP3WC41_p4D_r4B0zEBEAYYhXGCS0JtiZyO9XdJaSBvktMdRwaNPg41O8nAQvzjjh4j686JHVW93Wwt4tdjGq0KTcDCRqeN4puZw",
    "refresh_token": "https://cilogon.org/oauth2/refreshToken/6d13c5ac6205087ae7ab869e68f729b4/1584383526222"
  }
}
```

### Revoke token 
```bash
curl -X POST -i "localhost:8082/fabric/credmgr/revoke" -H "accept: application/json" -H "Content-Type: application/json" -d '{"refresh_token": "https://cilogon.org/oauth2/refreshToken/46438248f4b7691a851f88b0849d9687/1584383387474"}'
HTTP/1.0 200 OK
Content-Type: application/json
Content-Length: 106
Server: Werkzeug/1.0.0 Python/3.6.8
Date: Mon, 16 Mar 2020 18:32:38 GMT

{
  "message": "Token revoked successfully",
  "status": 200
}
```
## Identity Token examples
### Decoded Id Token Returned for projectName=all and scope=all
```
{
  "iss": "https://cilogon.org",
  "sub": "http://cilogon.org/serverA/users/11904101",
  "aud": "cilogon:/client_id/311cbebecefc7c1a6e0282e13fcf9588",
  "auth_time": "1584583311",
  "exp": 1584584211,
  "iat": 1584583311,
  "email": "kthare10@email.unc.edu",
  "given_name": "Komal",
  "family_name": "Thareja",
  "cert_subject_dn": "/DC=org/DC=cilogon/C=US/O=University of North Carolina at Chapel Hill/CN=Komal Thareja A11904106",
  "idp": "urn:mace:incommon:unc.edu",
  "idp_name": "University of North Carolina at Chapel Hill",
  "eppn": "kthare10@unc.edu",
  "affiliation": "employee@unc.edu;staff@unc.edu;member@unc.edu",
  "name": "Komal Thareja",
  "acr": "urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport",
  "entitlement": "urn:mace:dir:entitlement:common-lib-terms",
  "isMemberOf": [
    "CO:members:active",
    "CO:COU:Jupyterhub:members:active",
    "CO:COU:RENCI-TEST:members:active"
  ],
  "scope": "all",
  "project": "all"
}
```
### Decoded Token for projectName=RENCI-TEST and scope=measurement
```
{
  "iss": "https://cilogon.org",
  "sub": "http://cilogon.org/serverA/users/11904101",
  "aud": "cilogon:/client_id/311cbebecefc7c1a6e0282e13fcf9588",
  "auth_time": "1584583311",
  "exp": 1584584554,
  "iat": 1584583654,
  "email": "kthare10@email.unc.edu",
  "given_name": "Komal",
  "family_name": "Thareja",
  "cert_subject_dn": "/DC=org/DC=cilogon/C=US/O=University of North Carolina at Chapel Hill/CN=Komal Thareja A11904106",
  "idp": "urn:mace:incommon:unc.edu",
  "idp_name": "University of North Carolina at Chapel Hill",
  "eppn": "kthare10@unc.edu",
  "affiliation": "employee@unc.edu;staff@unc.edu;member@unc.edu",
  "name": "Komal Thareja",
  "acr": "urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport",
  "entitlement": "urn:mace:dir:entitlement:common-lib-terms",
  "isMemberOf": [
    "CO:COU:RENCI-TEST:members:active"
  ],
  "scope": "measurement",
  "project": "RENCI-TEST"
}
```
